clear
echo "this is my shell script"
if [ $# -lt 2 ]
then
echo "This script requires at least two parameters, termination URI and public IP address"
else
startingplace=$(pwd)
yes | yum groupinstall 'Development Tools'
yes | yum install ncurses-devel uuid-devel libuuid-devel libxml2-devel sqlite-devel bison
cd /usr/src/
git clone https://github.com/akheron/jansson.git
cd jansson
autoreconf -i
./configure -prefix=/usr/
make && make install
cd ..
yum install -y wget
sed -i.bak 's/SELINUX=enforcing/SELINUX=disabled/' /etc/selinux/config

cd /usr/src
yes | yum install words
wget http://downloads.sourceforge.net/project/srtp/srtp/1.4.4/srtp-1.4.4.tgz

tar zxvf srtp-1.4.4.tgz
cd /usr/src/srtp
./configure CFLAGS=-fPIC --prefix=/usr/local/lib
make
sed -i.bak 's|RTPW=rtpw|RTPW=./rtpw|' ./test/rtpw_test.sh
make runtest
make install

cd /usr/src
wget http://downloads.asterisk.org/pub/telephony/asterisk/asterisk-13-current.tar.gz
tar -xzvf asterisk*
cd asterisk-13.*
./bootstrap.sh
./configure --with-srtp=/usr/local/lib
make && make install
make samples
make config
make samples
ldconfig
chkconfig asterisk on
ldconfig
cd /etc/asterisk
mv sip.conf sip.conf.old
mv extensions.conf extensions.conf.old
mv voicemail.conf voicemail.conf.old
cd $startingplace
echo $(pwd)
echo $(ls)

sed -i.bak 's/TERMINATIONURI/'$1'/' ./sip.conf
sed -i.bak 's/OUTSIDE/'$2'/' ./sip.conf
sed -i.bak 's/replaceme/'$(cat /dev/urandom | tr -dc 'a-zA-Z0-9' | fold -w 16 | head -n 1)'/' ./sip.conf

if [ $# -gt 3 ]
then
sed -i.bak 's/USERNAME/'$3'/' ./sip.conf
sed -i.bak 's/PASSWORD/'$4'/' ./sip.conf
fi

cp sip.conf /etc/asterisk/sip.conf
cp extensions.conf /etc/asterisk/extensions.conf
cp voicemail.conf /etc/asterisk/voicemail.conf
cp extensions.conf.* /etc/asterisk/.

cd /var/lib/asterisk/sounds
wget http://downloads.asterisk.org/pub/telephony/sounds/asterisk-extra-sounds-en-gsm-current.tar.gz
tar -xzf asterisk-extra-sounds-en-gsm-current.tar.gz

randlen = $(((RANDOM % 8)+8))
tlspass = $(cat /dev/urandom | tr -dc 'a-zA-Z0-9' | fold -w $randlen | head -n 1)

cd /etc/asterisk
mkdir keys
cd /usr/src/asterisk-13.*
yes $tlspass | ./contrib/scripts/ast_tls_cert -C $2 -O "My PBX" -d /etc/asterisk/keys
fi
